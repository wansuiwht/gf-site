"use strict";(self.webpackChunkgf_site=self.webpackChunkgf_site||[]).push([["15112"],{739079:function(e,n,r){r.r(n),r.d(n,{metadata:()=>s,contentTitle:()=>l,default:()=>u,assets:()=>c,toc:()=>d,frontMatter:()=>i});var s=JSON.parse('{"id":"course/starbook/\u7B2C\u4E09\u7AE0-\u4F1A\u8BDD\u7BA1\u7406/3.2.\u767B\u5F55","title":"3.2.\u767B\u5F55","description":"\u767B\u5F55\u529F\u80FD\u901A\u8FC7\u63A5\u6536\u7528\u6237\u540D\u548C\u5BC6\u7801\uFF0C\u9A8C\u8BC1\u6210\u529F\u751F\u6210Token\u8FD4\u56DE\u3002\u91C7\u7528GoFrame\u6846\u67B6\uFF0C\u9075\u5FAA\u4E09\u677F\u65A7\u5F00\u53D1\u539F\u5219\uFF0C\u5305\u62ECApi\u751F\u6210Controller\uFF0C\u7F16\u5199\u6838\u5FC3Logic\u903B\u8F91\u3002\u901A\u8FC7JwtKey\u751F\u6210\u7B7E\u540D\uFF0CToken\u6709\u6548\u671F\u4E3A\u516D\u5C0F\u65F6\u3002\u5728Controller\u4E2D\u8C03\u7528\u6838\u5FC3\u903B\u8F91\u5B9E\u73B0\u767B\u5F55\u529F\u80FD\uFF0C\u5E76\u6D4B\u8BD5\u63A5\u53E3\u786E\u4FDD\u529F\u80FD\u6B63\u5E38\u3002","source":"@site/docs/course/starbook/\u7B2C\u4E09\u7AE0-\u4F1A\u8BDD\u7BA1\u7406/3.2.\u767B\u5F55.md","sourceDirName":"course/starbook/\u7B2C\u4E09\u7AE0-\u4F1A\u8BDD\u7BA1\u7406","slug":"/course/starbook/session-login","permalink":"/course/starbook/session-login","draft":false,"unlisted":false,"editUrl":"https://github.com/gogf/gf-site/blob/main/docs/course/starbook/\u7B2C\u4E09\u7AE0-\u4F1A\u8BDD\u7BA1\u7406/3.2.\u767B\u5F55.md","tags":[],"version":"current","lastUpdatedBy":"John","lastUpdatedAt":1732373578000,"frontMatter":{"title":"3.2.\u767B\u5F55","hide_title":true,"slug":"/course/starbook/session-login","keywords":["GoFrame","\u767B\u5F55\u63A5\u53E3","\u7528\u6237\u8BA4\u8BC1","\u751F\u6210Token","\u5BC6\u7801\u52A0\u5BC6","\u7528\u6237\u8BF7\u6C42","\u9519\u8BEF\u5904\u7406","JwtKey","\u63A5\u53E3\u6D4B\u8BD5","\u7F16\u5199\u903B\u8F91"],"description":"\u767B\u5F55\u529F\u80FD\u901A\u8FC7\u63A5\u6536\u7528\u6237\u540D\u548C\u5BC6\u7801\uFF0C\u9A8C\u8BC1\u6210\u529F\u751F\u6210Token\u8FD4\u56DE\u3002\u91C7\u7528GoFrame\u6846\u67B6\uFF0C\u9075\u5FAA\u4E09\u677F\u65A7\u5F00\u53D1\u539F\u5219\uFF0C\u5305\u62ECApi\u751F\u6210Controller\uFF0C\u7F16\u5199\u6838\u5FC3Logic\u903B\u8F91\u3002\u901A\u8FC7JwtKey\u751F\u6210\u7B7E\u540D\uFF0CToken\u6709\u6548\u671F\u4E3A\u516D\u5C0F\u65F6\u3002\u5728Controller\u4E2D\u8C03\u7528\u6838\u5FC3\u903B\u8F91\u5B9E\u73B0\u767B\u5F55\u529F\u80FD\uFF0C\u5E76\u6D4B\u8BD5\u63A5\u53E3\u786E\u4FDD\u529F\u80FD\u6B63\u5E38\u3002"},"sidebar":"courseStarBookSidebar","previous":{"title":"3.1.\u524D\u7F6E\u8BF4\u660E","permalink":"/course/starbook/session-overview"},"next":{"title":"3.3.\u83B7\u53D6\u7528\u6237\u4FE1\u606F","permalink":"/course/starbook/session-get-user-info"}}'),o=r("785893"),t=r("250065");let i={title:"3.2.\u767B\u5F55",hide_title:!0,slug:"/course/starbook/session-login",keywords:["GoFrame","\u767B\u5F55\u63A5\u53E3","\u7528\u6237\u8BA4\u8BC1","\u751F\u6210Token","\u5BC6\u7801\u52A0\u5BC6","\u7528\u6237\u8BF7\u6C42","\u9519\u8BEF\u5904\u7406","JwtKey","\u63A5\u53E3\u6D4B\u8BD5","\u7F16\u5199\u903B\u8F91"],description:"\u767B\u5F55\u529F\u80FD\u901A\u8FC7\u63A5\u6536\u7528\u6237\u540D\u548C\u5BC6\u7801\uFF0C\u9A8C\u8BC1\u6210\u529F\u751F\u6210Token\u8FD4\u56DE\u3002\u91C7\u7528GoFrame\u6846\u67B6\uFF0C\u9075\u5FAA\u4E09\u677F\u65A7\u5F00\u53D1\u539F\u5219\uFF0C\u5305\u62ECApi\u751F\u6210Controller\uFF0C\u7F16\u5199\u6838\u5FC3Logic\u903B\u8F91\u3002\u901A\u8FC7JwtKey\u751F\u6210\u7B7E\u540D\uFF0CToken\u6709\u6548\u671F\u4E3A\u516D\u5C0F\u65F6\u3002\u5728Controller\u4E2D\u8C03\u7528\u6838\u5FC3\u903B\u8F91\u5B9E\u73B0\u767B\u5F55\u529F\u80FD\uFF0C\u5E76\u6D4B\u8BD5\u63A5\u53E3\u786E\u4FDD\u529F\u80FD\u6B63\u5E38\u3002"},l=void 0,c={},d=[{value:"\u6DFB\u52A0Api",id:"\u6DFB\u52A0api",level:2},{value:"\u7F16\u5199Logic",id:"\u7F16\u5199logic",level:2},{value:"Controller\u8C03\u7528Logic",id:"controller\u8C03\u7528logic",level:2},{value:"\u63A5\u53E3\u6D4B\u8BD5",id:"\u63A5\u53E3\u6D4B\u8BD5",level:2}];function a(e){let n={blockquote:"blockquote",code:"code",em:"em",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,t.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["\u767B\u5F55\u63A5\u53E3\u6536\u5230\u7528\u6237\u540D\u548C\u5BC6\u7801\u540E\uFF0C\u4E0E\u6570\u636E\u5E93\u4E2D\u7684\u4FE1\u606F\u505A\u6BD4\u5BF9\uFF0C\u5982\u679C\u6B63\u786E\u5219\u751F\u6210",(0,o.jsx)(n.code,{children:"Token"}),"\u8FD4\u56DE\uFF0C\u5426\u5219\u63D0\u793A\u201D\u7528\u6237\u540D\u6216\u5BC6\u7801\u9519\u8BEF\u201C\u3002"]}),"\n",(0,o.jsxs)(n.p,{children:["\u540C\u6837\u9075\u5FAA\u4E09\u677F\u65A7\u5F00\u53D1\u539F\u5219\uFF1A\u7F16\u5199",(0,o.jsx)(n.code,{children:"Api"}),"\u751F\u6210",(0,o.jsx)(n.code,{children:"Controller"}),"\uFF0C\u7F16\u5199\u6838\u5FC3\u903B\u8F91",(0,o.jsx)(n.code,{children:"Logic"}),"\uFF0C",(0,o.jsx)(n.code,{children:"Controller"}),"\u8C03\u8D77",(0,o.jsx)(n.code,{children:"Logic"}),"\u3002"]}),"\n",(0,o.jsx)(n.h2,{id:"\u6DFB\u52A0api",children:"\u6DFB\u52A0Api"}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.em,{children:"api/users/v1/users.go"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'...\n  \ntype LoginReq struct {  \n    g.Meta   `path:"users/login" method:"post" sm:"\u767B\u5F55" tags:"\u7528\u6237"`  \n    Username string `json:"username" v:"required|length:3,12"`  \n    Password string `json:"password" v:"required|length:6,16"`  \n}  \n  \ntype LoginRes struct {  \n    Token string `json:"token" dc:"\u5728\u9700\u8981\u9274\u6743\u7684\u63A5\u53E3\u4E2Dheader\u52A0\u5165Authorization: token"`\n}\n'})}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsxs)(n.p,{children:["\u522B\u5FD8\u8BB0\u6267\u884C",(0,o.jsx)(n.code,{children:"gf gen ctrl"}),"\u54E6\uFF01\u6BCF\u6B21\u53D8\u66F4",(0,o.jsx)(n.code,{children:"Api"}),"\u90FD\u9700\u8981\u6267\u884C\u5B83\uFF0C\u540E\u6587\u4E0D\u518D\u91CD\u590D\u63D0\u793A\u3002"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"\u7F16\u5199logic",children:"\u7F16\u5199Logic"}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsxs)(n.p,{children:["\u767B\u5F55\u903B\u8F91\u7684\u7684\u96BE\u70B9\u5728\u4E8E\u751F\u6210",(0,o.jsx)(n.code,{children:"Token"}),"\u3002\u51C6\u5907\u597D\u4E00\u4E2A\u968F\u673A\u5B57\u7B26\u4E32",(0,o.jsx)(n.code,{children:"JwtKey"}),"\u7528\u4F5C\u7B7E\u540D\uFF0C\u6211\u4EEC\u5C06\u5176\u5B9A\u4E49\u5728",(0,o.jsx)(n.code,{children:"utility"}),"\u76EE\u5F55\u4E0B\u3002"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.em,{children:"utility/jwt.go"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'package utility  \n  \nvar JwtKey = []byte("db03d23b03ec405793b38f10592a2f34")\n'})}),"\n",(0,o.jsxs)(n.p,{children:["\u7F16\u5199\u6838\u5FC3\u903B\u8F91\uFF0C\u5148\u6839\u636E\u7528\u6237\u540D\u8FDB\u884C",(0,o.jsx)(n.code,{children:"Where"}),"\u67E5\u8BE2\uFF0C\u83B7\u53D6\u5230\u6570\u636E\u540E\uFF0C\u5C06\u5BC6\u7801\u518D\u6B21\u52A0\u5BC6\uFF0C\u5982\u679C\u548C\u6570\u636E\u5E93\u4E2D\u7684\u5BC6\u6587\u4E00\u81F4\u5219\u8BF4\u660E\u662F\u5408\u6CD5\u7528\u6237\uFF0C\u751F\u6210",(0,o.jsx)(n.code,{children:"Token"}),"\u8FD4\u56DE\u3002"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.em,{children:"internal/logic/users/account.go"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'package users  \n  \nimport (  \n    "context"  \n    "errors"\n    "time"  \n    \n    "github.com/golang-jwt/jwt/v5"\n    \n    "star/internal/dao"    \n    "star/internal/model/entity"    \n    "star/utility"\n)\n  \ntype UserClaims struct {  \n    Id       uint  \n    Username string  \n    jwt.RegisteredClaims  \n}  \n  \nfunc Login(ctx context.Context, username, password string) (tokenString string, err error) {  \n    var user entity.Users  \n    err = dao.Users.Ctx(ctx).Where("username", username).Scan(&user)  \n    if err != nil {  \n       return "", errors.New("\u7528\u6237\u540D\u6216\u5BC6\u7801\u9519\u8BEF")  \n    }  \n  \n    if user.Id == 0 {  \n       return "", errors.New("\u7528\u6237\u4E0D\u5B58\u5728")  \n    }  \n  \n    // \u5C06\u5BC6\u7801\u52A0\u5BC6\u540E\u4E0E\u6570\u636E\u5E93\u4E2D\u7684\u5BC6\u7801\u8FDB\u884C\u6BD4\u5BF9  \n    if user.Password != encryptPassword(password) {  \n       return "", errors.New("\u7528\u6237\u540D\u6216\u5BC6\u7801\u9519\u8BEF")  \n    }  \n  \n    // \u751F\u6210token  \n    userClaims := &UserClaims{  \n       Id:       user.Id,  \n       Username: user.Username,  \n       RegisteredClaims: jwt.RegisteredClaims{  \n          ExpiresAt: jwt.NewNumericDate(time.Now().Add(6 * time.Hour)),  \n       },  \n    }  \n    token := jwt.NewWithClaims(jwt.SigningMethodHS256, userClaims)  \n    return token.SignedString(utility.JwtKey)  \n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["\u4ECE\u4E0A\u9762\u7684\u4EE3\u7801\u53EF\u4EE5\u770B\u5230\uFF0C\u6211\u4EEC\u9700\u8981\u58F0\u660E\u4E00\u4E2A\u7ED3\u6784\u4F53",(0,o.jsx)(n.code,{children:"UserClaims"}),"\u4FDD\u5B58\u7B7E\u540D\u4FE1\u606F\uFF0C\u8FD9\u91CC\u4FDD\u5B58\u4E86",(0,o.jsx)(n.code,{children:"Id"}),"\u548C",(0,o.jsx)(n.code,{children:"Username"}),"\u5E76\u8BBE\u7F6E\u4E86",(0,o.jsx)(n.code,{children:"Token"}),"\u6709\u6548\u671F\u4E3A 6 \u4E2A\u5C0F\u65F6\u3002\u6700\u540E\u7684\u58F0\u660E\u5BF9\u8C61\u8FD8\u9700\u8981\u8C03\u7528",(0,o.jsx)(n.code,{children:"SignedString"}),"\u65B9\u6CD5\u4F20\u5165",(0,o.jsx)(n.code,{children:"JwtKey"}),"\u751F\u6210\u7B7E\u540D\u3002"]}),"\n",(0,o.jsx)(n.h2,{id:"controller\u8C03\u7528logic",children:"Controller\u8C03\u7528Logic"}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.em,{children:"internal/controller/users/users_v1_login.go"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'package users  \n  \nimport (  \n    "context"  \n    \n    "star/internal/logic/users"  \n    "star/api/users/v1"\n)  \n  \nfunc (c *ControllerV1) Login(ctx context.Context, req *v1.LoginReq) (res *v1.LoginRes, err error) {  \n    token, err := users.Login(ctx, req.Username, req.Password)  \n    if err != nil {  \n       return  \n    }  \n    return &v1.LoginRes{Token: token}, nil  \n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"\u63A5\u53E3\u6D4B\u8BD5",children:"\u63A5\u53E3\u6D4B\u8BD5"}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'$ curl -X POST http://127.0.0.1:8000/v1/users/login -H "Content-Type: application/json" -d "{\\"username\\":\\"oldme\\", \\"password\\":\\"123456\\"}"\n\n{\n    "code":0,\n    "message":"",\n    "data":{\n        "token":"eyJhbGciOi...ZY_ATzOU"\n    }\n}\n'})})]})}function u(e={}){let{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},250065:function(e,n,r){r.d(n,{Z:function(){return l},a:function(){return i}});var s=r(667294);let o={},t=s.createContext(o);function i(e){let n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);